<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/core.js"></script>
<script src="../../src/GestureAttr.js"></script>

<style>
  div {
    position: absolute;
    width: 20vh;
    height: 32vh;
    margin: 10vh calc(50% - 10vh);
  }

  .right {
    transition: all 0.8s;
    transform: rotate(15deg);
    margin-left: 100vw;
  }

  .left {
    transition: all 0.8s;
    transform: rotate(-15deg);
    margin-left: -20vh;
  }
</style>

<body swipe:swipe-longer-than_100:left-right:await2_500:replace>
<div
    swipeable
    ready:random-color:this.owner-element.style.background-color_e
></div>
</body>

<script>
  //todo these should be moved into the core.js lib. The await2 is also used in the GestureAttr.
  customReactions.define("prevent", e => (e.preventDefault(), e));
  customReactions.define("await2", async (e, _, num) => {
    if (num && isNaN(num))
      throw new SyntaxError(`${_}_${num} is illegal, the _${num} is not a number.`);
    await (num ? new Promise(r => setTimeout(r, num)) : Promise.resolve());
    return e;
  });

  //todo the copyEvent should also be standardized. It is something that we can
  function copyEvent(e, prefix) {
    const copy = new e.constructor(prefix, e);
    eventLoop.dispatch(copy, this.ownerElement);
    return copy;
  }

  customReactions.define("swipe", copyEvent);
  customReactions.define("swipe-start", copyEvent);
  customReactions.define("swipe-cancel", copyEvent);

  let swipeStart = 0;

  customAttributes.define("swipeable", class SwipeAttr extends GestureAttr {
    static stateMachine() {
      return {
        "": [["mousedown:swipestart:swipe-start", "start"]],
        start: [
          ["_mouseup::swipe", ""],
          ["_blur:swipe-cancel", ""],
          ["_selectstart:prevent", ""]
        ]
      };
    }
  });

  customReactions.define("swipestart", e => ((swipeStart = e.x), e));

  customReactions.define("random-color", function randomColor() {
    return 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';
  });

  customReactions.define("replace", function replaceElement() {
    this.ownerElement.innerHTML = "<div swipeable ready:random-color:this.owner-element.style.background-color_e></div>";
  });

  customReactions.define("swipe-longer-than", function ({x}, _, length) {
    const swipeDist = swipeStart - x;
    if (Math.abs(swipeDist) >= length)
      return swipeDist;
  });
  customReactions.define("left-right", function (e) {
    this.ownerElement.firstElementChild.classList.add(e > 0 ? "left" : "right");
    return e;
  });
</script>