<style>
  #viewport {
    width: 450px;
    height: 450px;
    position: relative;
    overflow: hidden;
    background-color: yellow;
  }

  #viewport > div {
    width: 450px;
    height: 450px;
    background-color: red;
  }
</style>

<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/GestureAttr.js"></script>

<div id="viewport" swipe-start:swipestart swipe-stop:swipestop:await2_500:replace>
  <div swipeable></div>
</div>

<script>
  let swipeStart = 0;

  customAttributes.define("swipeable", class SwipeAttr extends GestureAttr {
    static stateMachine() {
      return {
        "": [["mousedown:swipe_start", "start"]],
        start: [
          ["_mouseup:swipe_stop", ""],
          ["_blur:swipe_cancel", ""],
          ["_selectstart:prevent", ""]
        ]
      };
    }
  });

  customReactions.define("swipe", function (e, _, type) {
    eventLoop.dispatch(makeSwipeEvent(type, e), this.ownerElement);
    return e;
  });

  customReactions.define("prevent", e => (e.preventDefault(), e));
  customReactions.define("await2", async (e, _, num) => {
    if (num) {
      if (isNaN(num))
        throw new SyntaxError(`${_}_${num} is illegal, the _${num} is not a number.`);
      await new Promise(r => setTimeout(r, num));
    } else {
      await Promise.resolve();
    }
    return e;
  });

  customReactions.define("swipestart", e => swipeStart = e.x - e.target.offsetLeft);

  function makeSwipeEvent(type, {x, y}) {
    const composedEvent = new CustomEvent("swipe-" + type, {bubbles: true, composed: true});
    [composedEvent.x, composedEvent.y] = [x, y];
    return composedEvent;
  }

  function colorPicker() {
    return 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';
  }

  customReactions.define("replace", function replaceElement() {
    this.ownerElement.firstElementChild.remove();
    const el = document.createElement("div");
    el.setAttribute("swipeable");
    el.style.backgroundColor = colorPicker();
    this.ownerElement.append(el);
  });

  customReactions.define("swipestop", function swipeStop({x}) {
    const swipeDist = swipeStart - x;
    if (Math.abs(swipeDist) < 100) return;
    const frame = this.ownerElement.firstElementChild;
    frame.style.transitionDuration = "0.8s";
    frame.style.transform = `rotate(${swipeDist > 0 ? "-" : ""}15deg)`;
    frame.style.marginLeft = (swipeDist > 0 ? "-" : "") + "650px";
    return x;
  });
</script>