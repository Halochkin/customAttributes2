<style>
    #viewport {
        width: 450px;
        height: 450px;
        position: relative;
        overflow: hidden;
        background-color: yellow;
    }

    #viewport > div {
        width: 450px;
        height: 450px;
        background-color: red;
    }
</style>

<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/GestureAttr.js"></script>

<div swipe id="viewport">
    <div></div>
</div>

<script>
  let swipeStart = 0;
  const viewport = document.getElementById("viewport");
  viewport.setAttribute("swipe-start:swipestart");
  viewport.setAttribute("swipe-stop:swipestop");

  customAttributes.define("swipe", class SwipeAttr extends GestureAttr {
    static stateMachine() {
      return {
        init: [["mousedown:mousedowninitial_start", "start"]],
        start: [
          ["mouseup:onmouseup_stop", "stop"],
          ["blur:onblur_cancel", "stop"],
          ["selectstart:onselectstart", "stop"]
        ],
        stop: [["mousedown:mousedowninitial_start", "start"]]
      };
    }
  });

  customReactions.define("mousedowninitial", function (e, _, type) {
    eventLoop.dispatch(makeSwipeEvent(type, e), this.ownerElement);
    return e;
  });

  customReactions.define("onmouseup", function (e, _, type) {
    eventLoop.dispatch(makeSwipeEvent(type, e), this.ownerElement);
    return e;
  });

  customReactions.define("onblur", function (e, _, name) {
    eventLoop.dispatch(makeSwipeEvent(name, e), globalSequence.target);
    return e;
  });

  customReactions.define("onselectstart", function (e) {
    e.preventDefault();
    e.stopImmediatePropagation ? e.stopImmediatePropagation() : e.stopPropagation();
  });

  customReactions.define("swipestart", e => swipeStart = e.x - e.target.offsetLeft);

  function makeSwipeEvent(type, {x, y}) {
    const composedEvent = new CustomEvent("swipe-" + type, {bubbles: true, composed: true});
    [composedEvent.x, composedEvent.y] = [x, y];
    return composedEvent;
  }

  const colorPicker = () => 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';

  const swipeStop = function ({x}) {
    const swipeDist = swipeStart - x;
    if (Math.abs(swipeDist) < 100) return;
    const frame = viewport.firstElementChild;
    frame.style.transitionDuration = "0.8s";
    frame.style.transform = `rotate(${swipeDist > 0 ? "-" : ""}15deg)`;
    frame.style.marginLeft = (swipeDist > 0 ? "-" : "") + "650px";
    setTimeout(() => {
      frame.remove();
      const el = document.createElement("div");
      el.style.backgroundColor = colorPicker();
      viewport.append(el);
    }, 500);
  };

  customReactions.define("swipestop", swipeStop);
</script>
