<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swipe</title>

  <style>
    #elem {
      position: absolute;
      width: 450px;
      height: 450px;
      background-color: red;
    }

    #viewport {
      display: inline-block;
      width: 450px;
      height: 450px;
      position: relative;
      overflow: hidden;
      background-color: yellow;
      margin: 10px;
      /*margin-top: 20px;*/
      border-radius: 10px;
    }
  </style>

  <script src="../../src/customAttributes.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.0/startObserver.js"></script>

</head>
<body>

<div swipe id="viewport" touch-action="pan-left" pointer-distance="30">
  <div id="elem"></div>
</div>

</body>
<script>
  // -------------------------------------------------------------------
  function filterOnAttribute(e, attributeName) {                                                 //4. FilterByAttribute
    for (let el = e.target; el; el = el.parentNode) {
      if (!el.hasAttribute)
        return null;
      if (el.hasAttribute(attributeName))
        return el;
    }
    return null;
  }

  function makeSwipeEvent(name, {x, y, target}) {
    const composedEvent = new CustomEvent("swipe-" + name, {bubbles: true, composed: true});
    composedEvent.x = x;
    composedEvent.y = y;
    composedEvent.detail = target.offsetLeft;
    return composedEvent;
  }

  function captureEvent(e, stopProp) {
    e.preventDefault();
    stopProp && e.stopImmediatePropagation ? e.stopImmediatePropagation() : e.stopPropagation();
  }

  function replaceDefaultAction(target, composedEvent, trigger) {      //[3] ReplaceDefaultAction
    composedEvent.trigger = trigger;
    trigger.stopTrailingEvent = function () {
      composedEvent.stopImmediatePropagation ? composedEvent.stopImmediatePropagation() : composedEvent.stopPropagation();
    };
    trigger.preventDefault();
    return setTimeout(function () {
      target.dispatchEvent(composedEvent)
    }, 0);
  }

  function mouseOutOfBounds(trigger) {
    return trigger.clientY < 0 || trigger.clientX < 0 || trigger.clientX > window.innerWidth || trigger.clientY > window.innerHeight;
  }

  function updateSequence(sequence, e) {                                                         //7. TakeNote
    sequence.recorded.push(e);
    return sequence;
  }

  function startSequence(target, e) {                                                            //5. Event Sequence
    const body = document.querySelector("body");
    const sequence = {
      target,
      cancelMouseout: target.hasAttribute("swipe-cancel-pointerout"),
      swipeDuration: parseInt(target.getAttribute("pointer-duration")) || 50,                    //6. EventAttribute
      swipeDistance: parseInt(target.getAttribute("pointer-distance")) || 100,
      recorded: [e],
      userSelectStart: body.style.userSelect,                                                    //10. Grabtouch
    };
    document.children[0].style.userSelect = "none";
    //mousedown:button_0::swipestart
    target.removeAttribute("mousedown:button_0::mousedowninitial_swipe_start");
    target.setAttribute("mousedown:mousedownsecondary_cancel");
    target.setAttribute("mousemove:onmousemove_move");
    target.setAttribute("mouseup:onmouseup_stop");
    target.setAttribute("blur:onblur_cancel");
    target.setAttribute("selectstart:onselectstart");
    return sequence;
  }

  function stopSequence({target, userSelectStart}) {
    document.children[0].style.userSelect = userSelectStart;
    target.removeAttribute("mousedown:mousedownsecondary_cancel");
    target.removeAttribute("mousemove:onmousemove_move");
    target.removeAttribute("mouseup:onmouseup_stop");
    target.removeAttribute("blur:onblur_cancel");
    target.removeAttribute("selectstart:onselectstart");
    target.setAttribute("mousedown:button_0::mousedowninitial_swipe_start");
    return undefined;
  }

  customAttributes.define("swipe", class Swipe extends CustomAttr {

    upgrade() {
      this.ownerElement.setAttribute("mousedown:button_0::mousedowninitial_swipe_start");
    }

    destructor() {
      //todo
    }
  });


  function propCheck(e, prefix, val) {
    if (e[prefix] == val)
      return e;
  }

  customReactions.define("button", propCheck);

  let globalSequence;
  customReactions.define("mousedowninitial", function (e, prefix, attr, name) {
    const target = this.ownerElement;
    const composedEvent = makeSwipeEvent(name, e);
    globalSequence = startSequence(target, composedEvent);//todo this is the statemachine
    eventLoop.dispatch(composedEvent, target);
  });

  customReactions.define("mousedownsecondary", function (e, prefix, name) {
    const cancelEvent = makeSwipeEvent(name, e);
    const target = globalSequence.target;
    globalSequence = stopSequence(globalSequence);
    replaceDefaultAction(target, cancelEvent, e);
  });

  customReactions.define("onmousemove", function (e, prefix, name) {
    if (!globalSequence.cancelMouseout && mouseOutOfBounds(e)) {
      const cancelEvent = makeSwipeEvent("cancel", e);
      const target = globalSequence.target;
      globalSequence = stopSequence(globalSequence);
      replaceDefaultAction(target, cancelEvent, e);
      return;
    }
    const composedEvent = makeSwipeEvent(name, e);
    captureEvent(e, false);
    globalSequence = updateSequence(globalSequence, composedEvent);
    replaceDefaultAction(globalSequence.target, composedEvent, e);
  });

  customReactions.define("onmouseup", function (e, prefix, name) {
    const stopEvent = makeSwipeEvent(name, e);
    if (!stopEvent) return;
    // captureEvent(e, false);
    const target = globalSequence.target;    //todo this is no longer necessary
    globalSequence = stopSequence(globalSequence);
    eventLoop.dispatch(stopEvent, target);
    // replaceDefaultAction(target, stopEvent, e);
  });

  customReactions.define("onblur", function (e, prefix, name) {
    const blurInEvent = makeSwipeEvent(name, e);
    const target = globalSequence.target;
    globalSequence = stopSequence(globalSequence);
    replaceDefaultAction(target, blurInEvent, e);
  });

  customReactions.define("onselectstart", function (e) {
    e.preventDefault();
    e.stopImmediatePropagation ? e.stopImmediatePropagation() : e.stopPropagation();
  });

</script>

<script>

  function colorPicker() {
    return 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';
  }

  let viewport = document.getElementById("viewport");
  let swipeStart = 0;

  customReactions.define("listen1", function (e) {
    swipeStart = e.x - e.target.offsetLeft;
  });
  document.documentElement.setAttribute("swipe-start:listen1");

  const listen2 = e => {
    let swipeDist = swipeStart - e.x;
    viewport.children[0].style.transitionDuration = "0.8s";
    if (Math.abs(swipeDist) < 100) return;
    viewport.children[0].style.transform = swipeDist > 0 ? "rotate(15deg)" : "rotate(-15deg)";
    viewport.children[0].style.marginLeft = swipeDist > 0 ? "-650px" : "650px";
    setTimeout(() => {
      if (!viewport.children[0].parentNode)
        return;
      viewport.children[0].parentNode.removeChild(viewport.children[0]);
      let el = document.createElement("div");
      el.id = "elem";
      el.transitionDuration = "1s";
      el.style.backgroundColor = colorPicker();
      viewport.appendChild(el);
    }, 500);
  };
  customReactions.define("listen2", listen2);
  document.documentElement.setAttribute("swipe-stop:listen2");
</script>

</html>
