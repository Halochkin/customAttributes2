<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/core.js"></script>
<script src="../../src/GestureAttr.js"></script>

<style>
  div {
    position: absolute;
    width: 20vh;
    height: 32vh;
    margin: 10vh calc(50% - 10vh);
  }

  .right {
    transition: all 0.8s;
    transform: rotate(15deg);
    margin-left: 100vw;
  }

  .left {
    transition: all 0.8s;
    transform: rotate(-15deg);
    margin-left: -20vh;
  }
</style>

<body swipe:swipe-longer-than_100:replace>
<div
    swipeable_100
    swipe:swipe-longer-than_100:left-right:await_800:this.owner-element.remove
    ready:random-color:this.owner-element.style.background-color_e
></div>
</body>

<script>
  class SwipeEvent extends MouseEvent {
    constructor(type, dict, start) {
      super(type, dict);
      this.start = start;
      this.end = dict.x;
    }

    get direction() {
      //return ((Math.atan2(y, -x) * 180 / Math.PI) + 270) % 360;
      return this.end >= this.start ? "right" : "left";
    }

    get length() {
      return Math.abs(this.end - this.start);
    }
  }

  function copyEvent(e, prefix) {
    return new SwipeEvent(prefix, e, this.owner.value.split(" ")[1]);
  }

  customReactions.define("swipe", copyEvent);
  customReactions.define("swipe-start", copyEvent);
  customReactions.define("swipe-cancel", copyEvent);

  customAttributes.define("swipeable", class SwipeAttr extends GestureAttr {
    static stateMachine(prefix, length = 50) {
      return {
        "": [[`mousedown:owner-attr_${prefix}:swipestart:swipe-start:dispatch`, "start"]],
        start: [
          //todo add the start x,y, and have the swipe be a different class of event.
          [`_mouseup:owner-attr_${prefix}:swipe-long-enough_${length}:then_${prefix}::swipe:dispatch`, ""],
          [`_mouseup:else_${prefix}:owner-attr_${prefix}:swipe-cancel:dispatch`, ""],
          [`_blur:owner-attr_${prefix}:swipe-cancel:dispatch`, ""],
          [`_selectstart:owner-attr_${prefix}:prevent`, ""]
        ]
      };
    }
  });
  customReactions.define("owner-attr", function (e, _, type) {
    if (!this.owner)  //todo the owner attribute should only run on the first pass, not all the time.
      for (let at of this.ownerElement.attributes)
        if (at.type === type)
          this.owner = at;
    return e;
  });

  customReactions.define("swipestart", function (e) {
    this.owner.value = " " + e.x;
    return e;
  });

  customReactions.define("random-color", function randomColor() {
    return 'rgb(' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ',' + (Math.floor(Math.random() * 256)) + ')';
  });

  customReactions.define("replace", function replaceElement() {
    this.ownerElement.insertAdjacentHTML("afterbegin",
      `<div
    swipeable_100
    swipe:swipe-longer-than_100:left-right:await_800:this.owner-element.remove
    ready:random-color:this.owner-element.style.background-color_e
></div>`);
  });

  customReactions.define("swipe-long-enough", function (e, _, length) {
    if (Math.abs(this.owner.value.split(" ")[1] - e.x) >= length)
      return e;
  })

  customReactions.define("swipe-longer-than", function (e, _, length) {
    if (e.length >= length)
      return e;
  });
  customReactions.define("left-right", function (e) {
    this.ownerElement.classList.add(e.direction); //
    return e;
  });
</script>