<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/core.js"></script>
<script src="../../src/dotReaction.js"></script>
<script src="../../src/GestureAttr.js"></script>

<style>
    div {
        position: absolute;
        left: 10px;
        top: 10px;
        height: 200px;
        width: 200px;
        background-color: red;
        text-align: center;
    }
</style>
<body>
<div
        dragable_50_100
        drag-start:cache-event
        drag-move:cache-event:moveto_this.owner-element.style.left_e
        drag-move:random-color:._this.owner-element.style.background-color_e

        ready:random-color:._this.owner-element.style.background-color_e

>
</div>
</body>
<script>
  class DragEvent extends CustomEvent {
    constructor(type, dict, data) {
      const {x, y, timeStamp} = JSON.parse(data);
      super(type, dict, x, y, timeStamp);
      if(!x)
        debugger
      this.x = x;
      this.y = y;
      this.startTime = timeStamp;
    }

    get length() {
      return Math.abs(this.end - this.start);
    }
  }

  class FlingEvent extends CustomEvent {
    constructor(type, dict, start) {
      super(type, dict);
      this.start = start;
      this.end = dict.x;
      this.x = dict.x;
      this.y = dict.y;
    }

    flingAngle(x, y) {
      return ((Math.atan2(y, x) * 180 / Math.PI) + 270) % 360;
    }

    set details(evts) {
      debugger
      const [e, flingStart] = evts;
      const {x: x1, y: y1, timeStamp: ts1} = e;
      const {x: x2, y: y2, timeStamp: ts2} = flingStart;
      const [distX, distY, durationMs] = [x1 - x2, y1 - y2, ts1 - ts2];
      const distDiag = Math.sqrt(distX * distX + distY * distY);
      // {distX, distY, distDiag, durationMs};
      this.detail = {distX, distY, distDiag, durationMs, angle: this.flingAngle(distX, distY), x: x1, y: y1}

    }
  }

  function copyEvent(e, prefix) {
    return prefix.split("-")[0] === "drag" ?
      new DragEvent(prefix, e, this.owner.value.split(" ")[1]) :
      new FlingEvent(prefix, e, this.owner.value.split(" ")[1]);
  }

  // customReactions.define("drag", copyEvent);
  customReactions.define("fling", copyEvent);
  customReactions.define("drag-start", copyEvent);
  customReactions.define("drag-move", copyEvent);
  customReactions.define("drag-end", copyEvent);
  customReactions.define("drag-cancel", copyEvent);

  // function makeDraggingEvent(name, {x, y}) {
  //   const composedEvent = new CustomEvent("dragging-" + name, {bubbles: true, composed: true});
  //   [composedEvent.x, composedEvent.y] = [x, y];
  //   return composedEvent;
  // }

  customReactions.define("mouse-out-of-bounds", function (e, _, length) {
    if (!(e.clientY < 0 || e.clientX < 0 || e.clientX > window.innerWidth || e.clientY > window.innerHeight))
      return e;
  });


  customReactions.define("cache-event", function (e) {
    const {x, y, timeStamp} = e;
    if(!x)
      debugger
    const data = JSON.stringify({x, y, timeStamp});
    const meta = document.createElement("meta");
    meta.setAttribute("data", data);
    document.head.append(meta);
    console.log(e.type, data);
    return e;
  });

  customReactions.define("ondragstart", function (e) {
    const {x, y, timeStamp} = e;
    this.owner.value = JSON.stringify({x, y, timeStamp});
    return e;
  });

  customReactions.define("ondragmove", function (e) {
    const {x, y, timeStamp} = e;
    this.owner.value = " " + JSON.stringify({x, y, timeStamp});
    console.log("move");
    return e;
  });

  customReactions.define("moveto", function (e, top, left) {
    debugger
    //todo: run this
    return e;
  });


  customReactions.define("drag-long-enough", function (e, _, length) {
    debugger
    //todo: make fling event and compare e.distDiag and length
    if (e.detail.distDiag > length);
      return e;
  })

  customReactions.define("drag-fast-enough", function (e, _, flingDuration) {
    debugger
    //todo: run this and test
    // function findLastEventOlderThan(events, timeTest) {
    //   for (const event of events.reverse()) if (event.timeStamp < timeTest) return event;
    //   return null;
    // }
    const flingTime = e.timeStamp - flingDuration;
    const cachedEvents = [...document.head.querySelectorAll("meta[data]")].map(el => JSON.parse(el.getAttribute("data")))
    let evt;
    for (const event of cachedEvents)
      if (event.timeStamp < flingTime)
        evt = event;
    if (evt)
      return e;
  })

  customAttributes.define("dragable", class DragAttribute extends GestureAttr {

    static stateMachine(prefix, duration, length) {
      return {
        "": [[`mousedown:owner-attr_${prefix}:ondragstart:cache-event:drag-start:dispatch`, "start"]],
        start: [
          [`mousemove:owner-attr_${prefix}:ondragmove:mouse-out-of-bounds:cache-event:drag-move:dispatch`, ""],

          [`mouseup:owner-attr_${prefix}:drag-long-enough_${length}:drag-fast-enough_${duration}:then_${prefix}::fling:dispatch`, ""],
          [`mouseup:else_${prefix}owner-attr_${prefix}:drag-end:dispatch`, ""],

          [`_blur:owner-attr_${prefix}:drag-cancel:dispatch`, ""],
          [`_selectstart:owner-attr_${prefix}:prevent`, ""]
        ],
      };
    }
  });

  customReactions.define("owner-attr", function (e, prefix, type) {
    if (this.owner)  //todo the owner attribute should only run on the first pass, not all the time.
      return e;
    for (let at of this.ownerElement.attributes)
      if (at.type === type)
        return this.owner = at, e;
    throw new Error(`${prefix}_${type} can't find owner attribute.`);
  });

  customReactions.define("random-color", function randomColor() {
    return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
  });


  // let dragStart = undefined;
  // customReactions.define("listen1", ({x, y, target}) => dragStart = {
  //   x: x - target.offsetLeft,
  //   y: y - target.offsetTop
  // });
  // customReactions.define("listen2", ({
  //                                      target,
  //                                      x,
  //                                      y
  //                                    }) => [target.style.left, target.style.top] = [x - dragStart.x + "px", y - dragStart.y + "px"]);
  // customReactions.define("listen3", e => e.target.style.outline = "2px solid green");
  // customReactions.define("listen4", ({
  //                                      target,
  //                                      detail
  //                                    }) => ([target.style.left, target.style.top, target.style.transition] = [(detail.x - dragStart.x + detail.distX * 1.5) + "px", (detail.y - dragStart.y + detail.distY * 1.5) + "px", "all 0.3s cubic-bezier(0.39, 0.58, 0.57, 1)"], setTimeout(() => target.style.transition = undefined, 300)));


</script>