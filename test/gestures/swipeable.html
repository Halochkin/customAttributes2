<script src="https://cdn.jsdelivr.net/gh/orstavik/ElementObserver@1.1.2/observeElementCreation.js"></script>
<script src="../../src/customAttributes.js"></script>
<script src="../../src/dotReaction.js"></script>
<script src="../../src/core.js"></script>
<script src="../../src/GestureAttrSimple.js"></script>

<body
    swipe:log
    swipe-start:log
    swipe-cancel:log
>
<div swipeable_100></div>
</body>

<script>
  class SwipeEvent extends MouseEvent {
    constructor(type, dict, start) {
      super(type, dict);
      this.start = start;
      this.end = dict.x;
    }

    get direction() {
      //return ((Math.atan2(y, -x) * 180 / Math.PI) + 270) % 360;
      return this.end >= this.start ? "right" : "left";
    }

    get length() {
      return Math.abs(this.end - this.start);
    }
  }

  function copyEvent(e, prefix) {
    return new SwipeEvent(prefix, e, this.gesture.value.split(" ")[1]);
  }

  customReactions.define("swipe", copyEvent);
  customReactions.define("swipe-start", copyEvent);
  customReactions.define("swipe-cancel", copyEvent);

  customAttributes.define("swipeable", class SwipeAttr extends GestureAttr {
    static stateMachine(prefix, length = 50) {
      return {
        "": [["mousedown:.g.set-data_e.x:swipe-start:dispatch", "start"]],
        start: [
          [`_mouseup:.min-distance_${length}_e.x_g.data:then_${prefix}::swipe_e_g.data:dispatch`, ""],
          [`_mouseup:else_${prefix}:swipe-cancel:dispatch`, ""],
          ["_blur:swipe-cancel:dispatch", ""],
          ["_selectstart:prevent", ""]
        ]
      };
    }
  });
  customReactions.define("min-distance", (e, _, length, a, b) => Math.abs(a - b) >= length ? e : undefined)
  customReactions.define("log", e => (console.log(e.type, e.direction, e.length), e));
  (function () {
    const div = document.querySelector("div");
    setTimeout(_ => div.dispatchEvent(new MouseEvent("mousedown", {clientX: 5})), 50);
    setTimeout(_ => document.body.dispatchEvent(new MouseEvent("mouseup", {bubbles: true, clientX: 350})), 300);
  })();
  setTimeout(function () {
    const div = document.querySelector("div");
    setTimeout(_ => {
      const event = new MouseEvent("mousedown", {clientX: 505});
      return div.dispatchEvent(event);
    }, 50);
    setTimeout(_ => document.body.dispatchEvent(new MouseEvent("mouseup", {bubbles: true, clientX: 150})), 300);
  }, 1000);

</script>